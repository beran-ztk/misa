<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignWidth="800" d:DesignHeight="450"
             x:Class="Misa.Ui.Avalonia.Features.Details.Information.Extensions.Sessions.SessionView"
             xmlns:information="clr-namespace:Misa.Ui.Avalonia.Features.Details.Information.Extensions.Sessions"
             x:DataType="information:SessionViewModel"
             x:Name="Root">

    <StackPanel Spacing="12">

        <!-- Actions + Overview -->
        <Border Padding="12"
                Margin="10"
                CornerRadius="10"
                BorderThickness="1"
                BorderBrush="{StaticResource BrushBorder}"
                Background="{StaticResource BrushPrimaryBackgroundLighter}">

          <StackPanel Spacing="12">

            <!-- Action bar -->
            <StackPanel Orientation="Horizontal" Spacing="8">
              <Button Command="{Binding ShowStartSessionFormCommand}"
                      IsEnabled="{Binding CurrentSessionOverviewDto.CanStartSession}"
                      IsVisible="{Binding CurrentSessionOverviewDto.CanStartSession}">
                <Image Width="16" Height="16"
                       Source="{SvgImage /Assets/Images/Details/play.svg}"/>
              </Button>

              <Button Command="{Binding ShowPauseSessionFormCommand}"
                      IsEnabled="{Binding CurrentSessionOverviewDto.CanPauseSession}"
                      IsVisible="{Binding CurrentSessionOverviewDto.CanPauseSession}">
                <Image Width="16" Height="16"
                       Source="{SvgImage /Assets/Images/Details/pause.svg}"/>
              </Button>

              <Button Command="{Binding ContinueSessionCommand}"
                      IsEnabled="{Binding CurrentSessionOverviewDto.CanContinueSession}"
                      IsVisible="{Binding CurrentSessionOverviewDto.CanContinueSession}">
                <Image Width="16" Height="16"
                       Source="{SvgImage /Assets/Images/Details/play-pause.svg}"/>
              </Button>

              <Button Command="{Binding ShowStopSessionFormCommand}"
                      IsEnabled="{Binding CurrentSessionOverviewDto.CanStopSession}"
                      IsVisible="{Binding CurrentSessionOverviewDto.CanStopSession}">
                <Image Width="16" Height="16"
                       Source="{SvgImage /Assets/Images/Details/stop.svg}"/>
              </Button>
            </StackPanel>

            <Separator/>

            <StackPanel Spacing="8">

              <TextBlock Text="Current session" FontWeight="SemiBold"/>

              <!-- Current session card -->
              <Border Padding="10"
                      CornerRadius="8"
                      BorderThickness="1"
                      BorderBrush="{StaticResource BrushBorder}"
                      Background="{StaticResource BrushPrimaryBackgroundLighter}">
                <StackPanel x:Name="Roots">
                  <!-- Active session content -->
                  <Border IsVisible="{Binding HasActiveSession}">
                      <Grid ColumnDefinitions="Auto,*,Auto"
                            RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                            RowSpacing="6"
                            ColumnSpacing="12"
                            DataContext="{Binding CurrentSessionOverviewDto.ActiveSession}">

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="State" Opacity="0.7"/>
                        <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding State.Name}" FontWeight="SemiBold" Foreground="Chocolate"/>
                        <TextBlock Grid.Row="0" Grid.Column="2" 
                                   Text="{Binding ElapsedTime}" 
                                   Foreground="Crimson"
                                   FontWeight="SemiBold" 
                                   HorizontalAlignment="Right"/>
                        
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Objective" Opacity="0.7"/>
                        <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding Objective}" TextWrapping="Wrap"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Planned" Opacity="0.7"/>
                        <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Spacing="6">
                          <TextBlock Text="{Binding PlannedDuration}"/>
                          <TextBlock Text="(auto stop)" Opacity="0.7"
                                     IsVisible="{Binding StopAutomatically}"/>
                          <TextBlock Text="{Binding AutoStopReason}" Opacity="0.7"
                                     IsVisible="{Binding StopAutomatically}"/>
                        </StackPanel>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Created" Opacity="0.7"/>
                        <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding CreatedAtUtc}"/>

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Segments" Opacity="0.7"/>
                        <ItemsControl Grid.Row="4" Grid.Column="1" ItemsSource="{Binding Segments}">
                          <ItemsControl.ItemTemplate>
                            <DataTemplate>
                              <Border Padding="8"
                                      Margin="0,0,0,6"
                                      CornerRadius="6"
                                      BorderThickness="1"
                                      BorderBrush="{StaticResource BrushBorder}"
                                      Background="{StaticResource BrushPrimaryBackgroundLighter}">
                                <Grid ColumnDefinitions="Auto,*,Auto"
                                      RowDefinitions="Auto,Auto"
                                      ColumnSpacing="10"
                                      RowSpacing="4">
                                  <TextBlock Grid.Row="0" Grid.Column="0" Text="Start" Opacity="0.7"/>
                                  <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding StartedAtUtc}"/>

                                  <TextBlock Grid.Row="1" Grid.Column="0" Text="End" Opacity="0.7"/>
                                  <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding EndedAtUtc}"/>

                                  <TextBlock Grid.Row="1" Grid.Column="2"
                                             Text="{Binding PauseReason}"
                                             Opacity="0.7"
                                             TextWrapping="Wrap"
                                             HorizontalAlignment="Right"/>
                                </Grid>
                              </Border>
                            </DataTemplate>
                          </ItemsControl.ItemTemplate>
                        </ItemsControl>
                      </Grid>
                  </Border>
                  

                  <!-- Current empty state -->
                  <Border IsVisible="{Binding !HasActiveSession}">
                      <TextBlock Text="No active session."
                                 Opacity="0.7"/>
                  </Border>
                </StackPanel>
              </Border>

              <TextBlock Text="Latest closed session" FontWeight="SemiBold" Margin="0,8,0,0"/>

              <!-- Latest closed session card -->
              <Border Padding="10"
                      CornerRadius="8"
                      BorderThickness="1"
                      BorderBrush="{StaticResource BrushBorder}"
                      Background="{StaticResource BrushPrimaryBackgroundLighter}">
                <StackPanel>
                  <!-- Latest session content -->
                  <Border IsVisible="{Binding HasLatestClosedSession}">
                      <Grid ColumnDefinitions="Auto,*"
                            RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                            RowSpacing="6"
                            ColumnSpacing="12"
                            DataContext="{Binding CurrentSessionOverviewDto.LatestClosedSession}">

                          <TextBlock Grid.Row="0" Grid.Column="0" Text="State" Opacity="0.7"/>
                          <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding State.Name}" FontWeight="SemiBold"/>

                          <TextBlock Grid.Row="1" Grid.Column="0" Text="Efficiency" Opacity="0.7"/>
                          <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Spacing="8" DataContext="{Binding Efficiency}">
                              <TextBlock Text="{Binding Name}"/>
                              <TextBlock Text="{Binding Synopsis}" Opacity="0.7"/>
                          </StackPanel>

                          <TextBlock Grid.Row="2" Grid.Column="0" Text="Concentration" Opacity="0.7"/>
                          <StackPanel Grid.Row="2" Grid.Column="1" Orientation="Horizontal" Spacing="8" DataContext="{Binding Concentration}">
                              <TextBlock Text="{Binding Name}"/>
                              <TextBlock Text="{Binding Synopsis}" Opacity="0.7"/>
                          </StackPanel>

                          <TextBlock Grid.Row="3" Grid.Column="0" Text="Summary" Opacity="0.7"/>
                          <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding Summary}" TextWrapping="Wrap"/>

                          <TextBlock Grid.Row="4" Grid.Column="0" Text="Created" Opacity="0.7"/>
                          <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding CreatedAtUtc}"/>
                      </Grid>
                  </Border>

                  <!-- Latest empty state -->
                  <Border IsVisible="{Binding !HasLatestClosedSession}">
                      <TextBlock Text="No closed session yet."
                                 Opacity="0.7"/>
                  </Border>
                </StackPanel>
              </Border>

            </StackPanel>

          </StackPanel>
        </Border>


        <!-- Start-Session Form -->
        <Border Padding="12"
                Margin="10,0,10,10"
                CornerRadius="10"
                BorderThickness="1"
                BorderBrush="{StaticResource BrushBorder}"
                Background="{StaticResource BrushPrimaryBackgroundLighter}"
                IsVisible="{Binding IsStartSessionFormOpen}">

            <StackPanel Spacing="10">
                <TextBlock Text="Start session"
                           FontWeight="SemiBold"/>

                <Grid ColumnDefinitions="140,*"
                      RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                      RowSpacing="8"
                      ColumnSpacing="10">

                    <TextBlock Grid.Row="0" Grid.Column="0"
                               VerticalAlignment="Center"
                               Text="Planned (min)" />
                    <NumericUpDown Grid.Row="0" Grid.Column="1"
                                   Classes="misa-input"
                                   Minimum="1" Maximum="600"
                                   Value="{Binding PlannedMinutes, Mode=TwoWay}" />

                    <TextBlock Grid.Row="1" Grid.Column="0"
                               VerticalAlignment="Center"
                               Text="Objective" />
                    <TextBox Grid.Row="1" Grid.Column="1"
                             Classes="misa-input"
                             Text="{Binding Objective, Mode=TwoWay}"
                             Watermark="What are you doing?" />

                    <TextBlock Grid.Row="2" Grid.Column="0"
                               VerticalAlignment="Center"
                               Text="Auto stop" />
                    <CheckBox Grid.Row="2" Grid.Column="1"
                              IsChecked="{Binding StopAutomatically, Mode=TwoWay}"
                              Content="Stop automatically after planned duration" />

                    <TextBlock Grid.Row="3" Grid.Column="0"
                               VerticalAlignment="Center"
                               Text="Reason" />
                    <TextBox Grid.Row="3" Grid.Column="1"
                             Classes="misa-input"
                             IsEnabled="{Binding StopAutomatically}"
                             Text="{Binding AutoStopReason, Mode=TwoWay}"
                             Watermark="Optional reason" />

                    <TextBlock Grid.Row="4" Grid.Column="0" Text=" " />
                    <StackPanel Grid.Row="4" Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="8"
                                HorizontalAlignment="Right">
                        <Button Content="Cancel"
                                Command="{Binding CloseStartSessionFormCommand}" />
                        <Button Content="Save"
                                Command="{Binding StartSessionCommand}" />
                    </StackPanel>
                </Grid>
            </StackPanel>
        </Border>

        <Border Padding="12"
                Margin="10,0,10,10"
                CornerRadius="10"
                BorderThickness="1"
                BorderBrush="{StaticResource BrushBorder}"
                Background="{StaticResource BrushPrimaryBackgroundLighter}"
                IsVisible="{Binding IsPauseSessionFormOpen}">

            <StackPanel Spacing="10">
                <TextBlock Text="Pause session"
                           FontWeight="SemiBold"/>

                <Grid ColumnDefinitions="*"
                      RowDefinitions="Auto,Auto"
                      RowSpacing="8"
                      ColumnSpacing="10">

                    <TextBlock Grid.Row="0" VerticalAlignment="Top" Text="What is the reason to pause your session?" />
                    <StackPanel Grid.Row="1" Spacing="8">
                        <TextBox Classes="misa-input"
                                 Text="{Binding PauseReason, Mode=TwoWay}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MinHeight="80"/>

                        <StackPanel Orientation="Horizontal"
                                    Spacing="8"
                                    HorizontalAlignment="Right">
                            <Button Command="{Binding ClosePauseSessionFormCommand}" 
                                    Content="Cancel"/>
                            <Button Content="Save"
                                    Command="{Binding PauseSessionCommand}" />
                        </StackPanel>
                    </StackPanel>

                </Grid>

            </StackPanel>
        </Border>
        
        <Border Padding="12"
                Margin="10,0,10,10"
                CornerRadius="10"
                BorderThickness="1"
                BorderBrush="{StaticResource BrushBorder}"
                Background="{StaticResource BrushPrimaryBackgroundLighter}"
                IsVisible="{Binding IsStopSessionFormOpen}">
            <StackPanel Spacing="10">
                <TextBlock Text="Stop session"
                           FontWeight="SemiBold"/>

                <Grid ColumnDefinitions="140,*"
                      RowDefinitions="Auto,Auto,Auto"
                      RowSpacing="8"
                      ColumnSpacing="10">

                    <TextBlock Grid.Row="0" Grid.Column="0" VerticalAlignment="Center" Text="Efficiency" />
                    <ComboBox Grid.Row="0" Grid.Column="1"
                              Classes="misa-input"
                              ItemsSource="{Binding EfficiencyTypes}"
                              SelectedValue="{Binding EfficiencyId}"
                              SelectedValueBinding="{Binding Id}"
                              DisplayMemberBinding="{Binding Name}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" VerticalAlignment="Center" Text="Concentration" />
                    <ComboBox Grid.Row="1" Grid.Column="1"
                              Classes="misa-input"
                              ItemsSource="{Binding ConcentrationTypes}"
                              SelectedValue="{Binding ConcentrationId}"
                              SelectedValueBinding="{Binding Id}"
                              DisplayMemberBinding="{Binding Name}" />

                    <TextBlock Grid.Row="2" Grid.Column="0" VerticalAlignment="Top" Text="Summary" />
                    <StackPanel Grid.Row="2" Grid.Column="1" Spacing="8">
                        <TextBox Classes="misa-input"
                                 Text="{Binding Summary, Mode=TwoWay}"
                                 AcceptsReturn="True"
                                 TextWrapping="Wrap"
                                 MinHeight="80"
                                 Watermark="What happened? Short summary." />

                        <StackPanel Orientation="Horizontal"
                                    Spacing="8"
                                    HorizontalAlignment="Right">
                            <Button Content="Cancel"
                                    Command="{Binding CloseStopSessionFormCommand}"/>
                            <Button Content="Save"
                                    Command="{Binding StopSessionCommand}" />
                        </StackPanel>
                    </StackPanel>

                </Grid>

            </StackPanel>
        </Border>
            
    </StackPanel>
</UserControl>
